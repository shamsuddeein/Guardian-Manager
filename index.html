<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Guardian Manager V2 | Monad Testnet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        :root { color-scheme: dark; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #f1f5f9; }
        .card { @apply bg-neutral-900 border border-neutral-800 rounded-2xl p-6 shadow-lg transition-all duration-300; }
        .btn { @apply bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-xl transition-all duration-200 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed; }
        .btn-destructive { @apply bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-xl transition; }
        .input { @apply w-full bg-neutral-800 border border-neutral-700 rounded-lg p-3 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition; }
        #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1051; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { transform: translateX(120%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); opacity: 0; }
        .toast.show { transform: translateX(0); opacity: 1; }
        .loader { border: 4px solid #4a5568; border-top: 4px solid #6366f1; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-neutral-950 text-gray-100 min-h-screen flex flex-col items-center antialiased">
    
    <!-- Header -->
    <header class="py-6 text-center w-full max-w-5xl px-6">
        <h1 class="text-3xl font-bold text-indigo-400">Guardian Manager V2</h1>
        <p class="text-gray-400 text-sm mt-1">Smart Account Security on Monad Testnet</p>
        
        <div id="wallet-info" class="hidden items-center justify-center mt-4 space-x-4">
            <div class="flex items-center space-x-2 text-sm bg-neutral-900 border border-neutral-800 px-3 py-1.5 rounded-full">
                <span id="network-status-dot" class="h-2 w-2 rounded-full bg-green-500"></span>
                <span id="network-status-text" class="text-gray-300">Monad Testnet</span>
            </div>
            <span id="wallet-address" class="text-sm font-mono text-gray-400"></span>
            <button id="disconnect-btn" class="text-xs text-red-400 hover:text-red-300 font-semibold">Disconnect</button>
        </div>
        
        <button id="connectWalletBtn" class="btn mt-4">Connect Wallet</button>
    </header>

    <!-- Main Content (Hidden until connected) -->
    <main id="app-content" class="w-full max-w-5xl p-6 space-y-8 hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="card col-span-1 lg:col-span-2">
                <h2 class="text-xl font-semibold mb-4">Daily Spending Limit</h2>
                <div class="relative w-full bg-neutral-800 rounded-full h-4 overflow-hidden border border-neutral-700">
                    <div id="spend-progress-bar" class="bg-indigo-600 h-full rounded-full transition-all duration-500" style="width: 0%;"></div>
                </div>
                <div class="flex justify-between items-center mt-2 text-sm text-gray-400">
                    <span>Spent: <span id="spent-today" class="font-mono">0.0</span> MON</span>
                    <span>Limit: <span id="allowance-limit" class="font-mono">0.0</span> MON</span>
                </div>
            </div>
            <div class="card">
                <h2 class="text-xl font-semibold mb-2">Account Balance</h2>
                <p class="text-3xl font-mono text-indigo-400"><span id="wallet-balance">--</span> <span class="text-xl">MON</span></p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="card">
                <h2 class="text-xl font-semibold mb-4">Guardian Management</h2>
                <div class="flex space-x-2"><input id="guardianAddress" type="text" placeholder="Guardian address (0x...)" class="input"><button id="addGuardianBtn" class="btn">Add</button></div>
                <ul id="guardianList" class="mt-4 space-y-3 text-sm text-gray-300"></ul>
            </div>
            <div class="card">
                <h2 class="text-xl font-semibold mb-4">Set Daily Allowance</h2>
                <div class="flex space-x-2"><input id="allowanceInput" type="number" placeholder="Amount in MON" class="input"><button id="setAllowanceBtn" class="btn">Set</button></div>
            </div>
            <div class="card">
                <h2 class="text-xl font-semibold mb-4">Execute Spend</h2>
                <div class="space-y-3"><input id="spendTo" type="text" placeholder="Recipient (0x...)" class="input"><input id="spendAmount" type="number" placeholder="Amount in MON" class="input"><button id="spendBtn" class="btn w-full">Send MON</button></div>
            </div>
            <div class="card">
                <h2 class="text-xl font-semibold mb-4">Social Recovery</h2>
                <div id="recovery-status-panel" class="p-4 rounded-lg bg-neutral-800/50 border border-neutral-700 text-center mb-4">
                    <p class="font-semibold text-lg"><span id="recovery-votes">0</span> / 3 Votes</p>
                    <p class="text-xs text-gray-400">Required for recovery</p>
                    <p id="proposed-owner-text" class="text-xs mt-2 text-indigo-400 font-mono hidden"></p>
                </div>
                <div class="space-y-3"><input id="recoveryAddress" type="text" placeholder="Proposed new owner (0x...)" class="input"><button id="voteRecoveryBtn" class="btn w-full">Vote for Recovery</button><button id="cancelRecoveryBtn" class="btn-destructive w-full">Cancel Recovery</button></div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="toast-container"></div>
    <div id="tx-status" class="fixed inset-0 z-[1200] hidden items-center justify-center bg-black/60 backdrop-blur-sm"><div class="bg-gray-800 p-8 rounded-xl text-center shadow-2xl flex flex-col items-center"><div class="loader mb-4"></div><p class="text-gray-300 font-medium" id="tx-status-text">Processing...</p></div></div>
    <div id="select-wallet-modal" class="fixed inset-0 z-[1100] hidden items-center justify-center bg-black/60 backdrop-blur-sm"><div class="card max-w-sm w-full"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold">Select Wallet</h3><button id="close-wallet-modal" class="text-gray-400 text-2xl">&times;</button></div><div id="wallet-list" class="space-y-2"></div></div></div>
    <div id="wrongNetworkModal" class="fixed inset-0 z-[1050] hidden items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="card max-w-md w-full">
            <div class="flex items-center gap-4"><i class="fa-solid fa-wifi text-yellow-400 text-2xl"></i><h3 class="text-xl font-semibold">Wrong Network</h3></div>
            <p class="text-gray-400 my-4">This dApp only runs on the Monad Testnet. Please switch your wallet to the correct network.</p>
            <button id="switch-network-btn" class="btn w-full">Switch to Monad Testnet</button>
        </div>
    </div>

    <script>
        const CONTRACT_ADDRESS = "0xd3310739AF89EceC9EE327C17243C8347e252310";
        const MONAD_TESTNET_CHAIN_ID_HEX = '0x279f'; // 10143
        const MONAD_TESTNET_CHAIN_ID_DEC = 10143;
        const MONAD_TESTNET_PARAMS = { chainId: MONAD_TESTNET_CHAIN_ID_HEX, chainName: 'Monad Testnet', nativeCurrency: { name: 'MON', symbol: 'MON', decimals: 18 }, rpcUrls: ['https://testnet-rpc.monad.xyz/'], blockExplorerUrls: ['https://testnet.monadexplorer.com/'] };
        const CONTRACT_ABI = [{"type":"constructor","inputs":[],"stateMutability":"nonpayable"},{"type":"event","name":"AllowanceChanged","inputs":[{"name":"newAllowance","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"GuardianAdded","inputs":[{"name":"guardian","type":"address","indexed":true,"internalType":"address"}],"anonymous":false},{"type":"event","name":"GuardianRemoved","inputs":[{"name":"guardian","type":"address","indexed":true,"internalType":"address"}],"anonymous":false},{"type":"event","name":"OwnerRecovered","inputs":[{"name":"oldOwner","type":"address","indexed":true,"internalType":"address"},{"name":"newOwner","type":"address","indexed":true,"internalType":"address"}],"anonymous":false},{"type":"event","name":"RecoveryCancelled","inputs":[{"name":"cancelledBy","type":"address","indexed":true,"internalType":"address"}],"anonymous":false},{"type":"event","name":"RecoveryInitiated","inputs":[{"name":"proposedOwner","type":"address","indexed":true,"internalType":"address"},{"name":"initiator","type":"address","indexed":true,"internalType":"address"}],"anonymous":false},{"type":"event","name":"RecoveryVote","inputs":[{"name":"guardian","type":"address","indexed":true,"internalType":"address"},{"name":"proposedOwner","type":"address","indexed":true,"internalType":"address"},{"name":"votes","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"SpendExecuted","inputs":[{"name":"to","type":"address","indexed":true,"internalType":"address"},{"name":"amount","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"function","name":"addGuardian","inputs":[{"name":"_guardian","type":"address","internalType":"address"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"approveRecovery","inputs":[{"name":"_newOwner","type":"address","internalType":"address"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"cancelRecovery","inputs":[],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"dailyAllowance","inputs":[],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"getAllowance","outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"getGuardians","outputs":[{"name":"","type":"address[]","internalType":"address[]"}],"stateMutability":"view"},{"type":"function","name":"getProposedNewOwner","outputs":[{"name":"","type":"address","internalType":"address"}],"stateMutability":"view"},{"type":"function","name":"getRecoveryVoteCount","outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"getSpentToday","outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"hasVotedFor","inputs":[{"name":"_guardian","type":"address","internalType":"address"}],"outputs":[{"name":"","type":"bool","internalType":"bool"}],"stateMutability":"view"},{"type":"function","name":"isGuardian","inputs":[{"name":"","type":"address","internalType":"address"}],"outputs":[{"name":"","type":"bool","internalType":"bool"}],"stateMutability":"view"},{"type":"function","name":"lastSpendTimestamp","inputs":[],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"owner","outputs":[{"name":"","type":"address","internalType":"address"}],"stateMutability":"view"},{"type":"function","name":"proposedNewOwner","inputs":[],"outputs":[{"name":"","type":"address","internalType":"address"}],"stateMutability":"view"},{"type":"function","name":"recoveryActive","inputs":[],"outputs":[{"name":"","type":"bool","internalType":"bool"}],"stateMutability":"view"},{"type":"function","name":"recoveryStartedAt","inputs":[],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"recoveryVoteCount","inputs":[],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"recoveryVotes","inputs":[{"name":"","type":"address","internalType":"address"}],"outputs":[{"name":"","type":"bool","internalType":"bool"}],"stateMutability":"view"},{"type":"function","name":"removeGuardian","inputs":[{"name":"_guardian","type":"address","internalType":"address"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"setAllowance","inputs":[{"name":"_newAllowance","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"spend","inputs":[{"name":"_to","type":"address","internalType":"address payable"},{"name":"_amount","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"spentToday","inputs":[],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"}];
        
        let provider, signer, contract, userAddress, selectedProvider;
        let discoveredProviders = [];

        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const walletInfoEl = document.getElementById('wallet-info');
        const walletAddressEl = document.getElementById('wallet-address');
        const appContentEl = document.getElementById('app-content');
        
        const showTxStatus = (msg) => { document.getElementById('tx-status-text').textContent = msg; document.getElementById('tx-status').classList.remove('hidden'); document.getElementById('tx-status').classList.add('flex'); };
        const hideTxStatus = () => { document.getElementById('tx-status').classList.add('hidden'); document.getElementById('tx-status').classList.remove('flex'); };
        const showToast = (message, isError = false) => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `toast p-3 rounded-lg shadow-lg text-white ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 3000);
        };
        const getErrorMessage = (error) => {
            if (error.code === 4001) return 'Transaction rejected by user.';
            return error.reason || error.data?.message || error.message || 'An unknown error occurred.';
        };

        const onAnnounceProvider = (event) => { if (!discoveredProviders.some(p => p.info.uuid === event.detail.info.uuid)) discoveredProviders.push(event.detail); };
        
        const connectWallet = async (providerDetail) => {
            selectedProvider = providerDetail.provider;
            try {
                const accounts = await selectedProvider.request({ method: 'eth_requestAccounts' });
                await initializeApp(accounts);
            } catch (error) { showToast(getErrorMessage(error), true); }
        };
        
        const initializeApp = async (accounts) => {
            if (accounts.length === 0) return disconnect();
            provider = new ethers.providers.Web3Provider(selectedProvider, "any");
            const network = await provider.getNetwork();
            if (network.chainId !== MONAD_TESTNET_CHAIN_ID_DEC) {
                document.getElementById('wrongNetworkModal').classList.remove('hidden');
                document.getElementById('wrongNetworkModal').classList.add('flex');
                return;
            }
            signer = await provider.getSigner();
            userAddress = await signer.getAddress();
            contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
            connectWalletBtn.classList.add('hidden');
            walletInfoEl.classList.remove('hidden');
            walletInfoEl.classList.add('flex');
            walletAddressEl.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
            appContentEl.classList.remove('hidden');
            selectedProvider.on('accountsChanged', () => window.location.reload());
            selectedProvider.on('chainChanged', () => window.location.reload());
            await refreshUI();
        };

        const disconnect = () => {
            provider = signer = contract = userAddress = selectedProvider = null;
            connectWalletBtn.classList.remove('hidden');
            walletInfoEl.classList.add('hidden');
            appContentEl.classList.add('hidden');
        };

        const switchNetwork = async () => {
            try {
                await selectedProvider.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: MONAD_TESTNET_CHAIN_ID_HEX }] });
            } catch(e) { showToast("Failed to switch network.", true); }
        };

        const refreshUI = async () => {
            if (!contract) return;
            try {
                const [guardians, allowance, spent, balance, recVotes, propOwner] = await Promise.all([
                    contract.getGuardians(), contract.getAllowance(), contract.getSpentToday(),
                    provider.getBalance(userAddress), contract.getRecoveryVoteCount(), contract.getProposedNewOwner()
                ]);

                const guardianList = document.getElementById("guardianList");
                guardianList.innerHTML = "";
                if (guardians.length === 0) {
                    guardianList.innerHTML = `<p class="text-sm text-center text-gray-400">No guardians added yet.</p>`;
                } else {
                    guardians.forEach(g => {
                        const li = document.createElement("li");
                        li.className = "flex justify-between items-center bg-neutral-800/50 p-2 rounded-lg";
                        li.innerHTML = `<span class="font-mono text-xs md:text-sm">${g}</span><button data-addr="${g}" class="remove-guardian-btn text-red-400 hover:text-red-500 text-xs font-semibold">REMOVE</button>`;
                        guardianList.appendChild(li);
                    });
                }

                const allowanceLimit = parseFloat(ethers.utils.formatEther(allowance));
                const spentToday = parseFloat(ethers.utils.formatEther(spent));
                document.getElementById('allowance-limit').textContent = `${allowanceLimit} MON`;
                document.getElementById('spent-today').textContent = `${spentToday.toFixed(4)} MON`;
                document.getElementById('spend-progress-bar').style.width = `${allowanceLimit > 0 ? (spentToday / allowanceLimit) * 100 : 0}%`;
                
                document.getElementById('wallet-balance').textContent = parseFloat(ethers.utils.formatEther(balance)).toFixed(4);

                document.getElementById('recovery-votes').textContent = recVotes.toString();
                const propOwnerEl = document.getElementById('proposed-owner-text');
                if (propOwner && propOwner !== ethers.constants.AddressZero) {
                    propOwnerEl.textContent = `Proposed: ${propOwner.substring(0, 6)}...`;
                    propOwnerEl.classList.remove('hidden');
                } else {
                    propOwnerEl.classList.add('hidden');
                }
            } catch (e) { showToast("Failed to load contract data.", true); console.error(e); }
        };

        const handleTx = async (txPromise, successMsg) => {
            showTxStatus("Sending transaction...");
            try {
                const tx = await txPromise;
                showTxStatus("Waiting for confirmation...");
                const receipt = await tx.wait();
                showToast(successMsg);
                await refreshUI();
                return receipt;
            } catch (error) {
                showToast(getErrorMessage(error), true);
            } finally {
                hideTxStatus();
            }
        };

        window.addEventListener('load', () => {
            window.addEventListener('eip6963:announceProvider', onAnnounceProvider);
            window.dispatchEvent(new Event('eip6963:requestProvider'));
            
            setTimeout(async () => {
                const providerDetail = discoveredProviders.find(p => p.info.rdns === "io.metamask") || discoveredProviders[0];
                if (providerDetail) {
                    const accounts = await providerDetail.provider.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        selectedProvider = providerDetail.provider;
                        initializeApp(accounts);
                    }
                }
            }, 300);

            connectWalletBtn.addEventListener('click', () => {
                const modal = document.getElementById('select-wallet-modal');
                const list = document.getElementById('wallet-list');
                list.innerHTML = '';
                if(discoveredProviders.length === 0) {
                    list.innerHTML = `<p class="text-gray-400">No wallet extensions detected.</p>`;
                }
                discoveredProviders.forEach(p => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left flex items-center gap-4 p-3 rounded-lg bg-neutral-700 hover:bg-neutral-600";
                    btn.innerHTML = `<img src="${p.info.icon}" alt="${p.info.name}" class="w-8 h-8 rounded-full"><span>${p.info.name}</span>`;
                    btn.onclick = () => { modal.classList.add('hidden'); connectWallet(p); };
                    list.appendChild(btn);
                });
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            });

            document.getElementById('close-wallet-modal').onclick = () => document.getElementById('select-wallet-modal').classList.add('hidden');
            document.getElementById('switch-network-btn').onclick = switchNetwork;
            disconnectBtn.addEventListener('click', disconnect);
            document.getElementById('addGuardianBtn').addEventListener('click', () => { const addr = document.getElementById('guardianAddress').value; if(ethers.utils.isAddress(addr)) { handleTx(contract.addGuardian(addr), "Guardian Added!"); document.getElementById('guardianAddress').value = ''; } else { showToast("Invalid address", true); }});
            document.getElementById('guardianList').addEventListener('click', (e) => { if (e.target.classList.contains('remove-guardian-btn')) { const addr = e.target.dataset.addr; if(confirm(`Remove guardian ${addr}?`)) { handleTx(contract.removeGuardian(addr), "Guardian Removed!"); } } });
            document.getElementById('setAllowanceBtn').addEventListener('click', () => { const amt = document.getElementById('allowanceInput').value; if(parseFloat(amt) >= 0) { handleTx(contract.setAllowance(ethers.utils.parseEther(amt)), "Allowance Set!"); } else { showToast("Invalid amount", true); } });
            document.getElementById('spendBtn').addEventListener('click', () => { const to = document.getElementById('spendTo').value; const amt = document.getElementById('spendAmount').value; if(ethers.utils.isAddress(to) && parseFloat(amt) > 0) { handleTx(contract.spend(to, ethers.utils.parseEther(amt)), "Spend Successful!"); } else { showToast("Invalid recipient or amount", true); } });
            document.getElementById('voteRecoveryBtn').addEventListener('click', () => { const addr = document.getElementById('recoveryAddress').value; if(ethers.utils.isAddress(addr)) { handleTx(contract.approveRecovery(addr), "Recovery Vote Submitted!"); } else { showToast("Invalid address", true); } });
            document.getElementById('cancelRecoveryBtn').addEventListener('click', () => { handleTx(contract.cancelRecovery(), "Recovery Cancelled!"); });
        });
    </script>
</body>
</html>

